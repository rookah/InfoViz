<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <style type="text/css" media="screen, print">

body { margin: 30px 50px; font-family: sans-serif; }

.centred {
	margin: auto;
	width: 100%;
}

.title {
	text-align: center;
	font-size: 30px;
	margin-bottom: 10px;
}

.inputDiv {
	background-color: #3275fc;
	width: 120px;
	text-align: center;
	padding: 2px;
	border-radius: 2px;
	user-select: none;
	color: white;
	position: absolute;
	display: inline-block;
}

.button {
	background-color: #3275fc;
	width: 120px;
	text-align: center;
	padding: 2px;
	border-radius: 2px;
	user-select: none;
	color: white;
	position: absolute;
	display: inline-block;
}

.button span {
	pointer-events: none;
}

.button:hover {
	background-color: #689afd;
	cursor: pointer;
}

.button:active {
	background-color: #9bbcfd;
}

.tool-tip {
    display: none;
    background-color: #404040;
    position: absolute;
    z-index: 3;
    color: white;
    padding: 5px 7px;
    text-align: center;
    border-width: 2px !important;
	border-radius: 2px;
    pointer-events: none;
    box-shadow:  1.5px 1.5px 1px 0 rgba(0, 0, 0, 0.2);
    font-size: 10px;
}

.chart {
    position: relative;
	margin-top: 40px;
	width: 800px;
	height: 500px;
}

.tool-tip:after {
	left: 0;
	bottom: -6px;
	border: solid transparent;
	content: " ";
	height: 0;
	width: 0;
	position: absolute;
	pointer-events: none;
	border-left-color: #404040;
	border-width: 6px;
	margin-top: -6px;
}
</style>

<title>World Inequality</title>

</head>

<body>

<div class="centred title">World Inequality</div>
<div class="chart">
	<div class="tool-tip"></div>
	<div class="button buttonToggle">Unstack</div>
	<div class="button buttonAll">All countries</div>
	<div class="inputDiv">
		<label>Year:
			<select class="inputYear"></select>
		</label>
	</div>
</div>
<script src="../vendor/d3/d3.js"></script>

<script>

//main
const margin = {top: 100, right: 50, bottom: 150, left: 45};
const width = 800 - margin.left - margin.right;
const height = 500 - margin.top - margin.bottom;

const svg = d3.select(".chart").append("svg")
    .attr("width", String(width + margin.left + margin.right))
    .attr("height", String(height + margin.top + margin.bottom))
    .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

// Converts a data point into a category based on "cumul"
const noCategs = 3;
	
function getCategory(cumul) {
	if (Number(cumul) >= 1) {
		return noCategs - 1;
	}
	if (Number(cumul) <= 0) {
		return 0;
	}
	return Math.floor(cumul * noCategs);
}

// getColour converts a row in the dataset to a colour
const getColour = (() => {
	const palette = ["#b4f8c8", "#fbc858", "#ff8210"];
	
	return (cumul) => palette[getCategory(cumul)];
})();


				
function formatYear(y) {
	return y + 1900;
}		

function unformatYear(y) {
	return y - 1900;
}
const maxYear = 120;


// Loads list of countries
d3.tsv("../data/countries.tsv", (error, countries) => {
	if(error) throw error;
			
d3.tsv(`../data/income_gini.tsv`, (error, gini) => {
	if(error) return;

	let data = [];

	const noCountries = 39;
	let counter = 0;
	for (let i = 0; i < countries.length; ++i) {

		// Loads income data
		d3.tsv(`../data/income/${countries[i].code}.tsv`, (error, dataTemp) => {
			if(error) return;
			
			++counter;
		   
			dataTemp.forEach(d => {
				d.country = i;
				d.year = unformatYear(d.year);
				d.code = countries[i].code;
				d.cumul = Math.min(Math.max(d.cumul, 0), 1);
				d.low = Math.min(Math.max(d.low, 0), 1);
				d.high = Math.min(Math.max(d.high, 0), 1);
				gini.forEach((obj) => {
					if (typeof d.gini === "undefined" && obj.country === countries[i].code && obj.year === dataTemp[0].year) {
						d.gini = obj.gini_index;
					}
				});
			});
			const latestData = dataTemp.filter(d => d.year === dataTemp[0].year);
			if (latestData.length < 100) { return; }
			data = data.concat(dataTemp);

			// Checks if all the data has finished loading
			if (counter === noCountries) {
				
				const defaultYear = unformatYear(2000);
				
				let timeChart = false;
				let selectedYear = defaultYear;
				let selectedCountry = "";
				
				// Updates level lines
				const updateLevelLines = (function() {
				
					// Granularity
					const granul = 1000;
					
					var arr = new Array(countries.length);
					var it = new Array(countries.length);
					for (let k = 0; k < countries.length; ++k) {
						it[k] = new Array(maxYear);
						arr[k] = new Array(maxYear);
						for (let l = 0; l < maxYear; ++l) {
							it[k][l] = 0;
							arr[k][l] = new Array(granul);
						}
					}
					
					data.forEach(d => {
						while (Math.max(d.cumul, 0) >= (it[d.country][d.year] / granul) ** 2) {
							arr[d.country][d.year][it[d.country][d.year]] = d.high;
							++it[d.country][d.year];
						}
					});
					
					return (d1) => {
						function getLevel(d) {
							const it = Math.floor((d1.cumul ** 0.5) * granul);
							return String(y((it === granul ? 1 : arr[d.country][d.year][it]) - (toggleStack ? heightBelow[getCategory(d1.cumul)][d.country][d.year] : 0)));
						}
						svg.selectAll(".levelLine")
							.attr("y1", getLevel)
							.attr("y2", getLevel)
							.attr("stroke", "black");
					};
				})();
				
				var x, xAxis;
					
				function yBar(d) {
					if (!toggleStack) {
						return String((1 - d.high) * height);
					}
					if (getCategory(d.cumul) !== oldCat) {
						holder = d.low;
						oldCat = getCategory(d.cumul);
						heightBelow[getCategory(d.cumul)][d.country][d.year] = d.low;
					}
					return String(y(d.high - holder));
				}
					
				const y = d3.scaleLinear()
					.range([height, 0]);
				
				// Draws the chart
				function drawChart() {
					svg.selectAll(".bar").remove();
					svg.selectAll(".levelLine").remove();
					svg.selectAll(".axis").remove();
					
					const filteredData = data.filter(d => {
						if (timeChart) {
							return Number(d.country) === Number(selectedCountry);
						} else {
							return Number(d.year) === Number(selectedYear);
						}
					});
					
					filteredData.sort((a, b) => (timeChart ? (a.year > b.year) : (a.gini > b.gini)) ? 1 : 0);
					
					x = d3.scaleBand().range([0, width]);
					const extent = d3.extent(filteredData, d => timeChart ? d.year : d.country);
					
					if (timeChart) {
						x.domain(d3.range(extent[0], extent[1] + 1));
					} else {
						x.padding(0.2)
						.domain(filteredData.map(d => timeChart ? d.year : d.country));
					}

					svg.append("g")
						.attr("class", "y axis")
						.call(d3.axisLeft(y));
					
					xAxis = d3.axisBottom(x)
						.tickFormat(d => timeChart ? formatYear(d) : countries[d].name);
						
					svg.append("g")
						.attr("class", "axis")
						.attr("transform", `translate(0, ${height})`)
						.call(xAxis)
						.selectAll("text")
							.attr("font-family", "sans-serif")
							.attr("font-size", "8px")
							.style("text-anchor", "end")
							.attr("dx", "-.8em")
							.attr("dy", ".15em")
							.attr("transform", d => "rotate(-65)");
					
					svg.selectAll(".bar")
						.append("div")
						.data(filteredData)
						.enter()
						.append("rect")
							.attr("class", "bar")
							.attr("x", d => String(x(timeChart ? d.year : d.country)))
							.attr("y", yBar)
							.attr("width", x.bandwidth())
							.attr("height", d => String(d.width * height + 1))
							.attr("fill", d => getColour(d.cumul))
							.on("mouseover", d => {
								if (!timeChart) {
									document.body.style.cursor = "pointer";
								}
								updateLevelLines(d);
								toolTip.style.display = "block";
								toolTip.innerText = `${countries[d.country].name} ${formatYear(d.year)}`;
								toolTip.style.left = `${String(margin.left + x(timeChart ? d.year : d.country) + 0.5 * x.bandwidth())}px`;
								toolTip.style.bottom = `${String((toggleStack ? y(1 - heightBelow[1][d.country]) : height) + margin.bottom + 10)}px`;
							})
							.on("mouseout", () => {
								document.body.style.cursor = "auto";
								svg.selectAll(".levelLine").attr("stroke", "");
								toolTip.style.display = "none";
							})
							.on("click", d => {
								document.body.style.cursor = "auto";
								if (timeChart) { return; }
								timeChart = true;
								selectedCountry = d.country;
								drawChart();
								buttonAll.style.display = "inline-block";
								inputDiv.style.display = "none";
							});
							
					// Creates level lines
					svg.selectAll(".levelLine")
						.data(filteredData.filter(d => Number(d.low) === 0))
						.enter()
						.append("line")
							.attr("class", "levelLine")
							.attr("x1", d => String(x(timeChart ? d.year : d.country)))
							.attr("x2", d => String(x(timeChart ? d.year : d.country) + x.bandwidth()))
							.attr("y1", d => String(50))
							.attr("y2", d => String(50))
							.attr("stroke-width", "2");
					d3.select(".chart-title")
						.text(`Proportion of population holding equal amounts of income${timeChart ? "  (" + countries[selectedCountry].name + ")" : ""}`);
				}
				
				var holder = 0;
				var oldCat = "";
				
				// Records the height below each category for each country and year (sum of heights of previous categories)
				var heightBelow = Array(noCategs - 1);
				for (let i = 0; i < noCategs; ++i) {
					heightBelow[i] = Array(countries.length);
					for (let j = 0; j < countries.length; ++j) {
						heightBelow[i][j] = Array(maxYear);
					}
				}
				
				// Buttons
				const buttonToggle = document.getElementsByClassName("buttonToggle")[0];
				const buttonToggleBox = buttonToggle.getBoundingClientRect();
					
				buttonToggle.style.left = `${margin.left + width - buttonToggleBox.width}px`;
				buttonToggle.style.top = `${margin.top - buttonToggleBox.height - 5}px`;
				
				let toggleStack = false;
						
				d3.select(".buttonToggle")
					.on("click", (evt) => {
						toggleStack = !toggleStack;
						d3.select(".button").text(toggleStack ? "Stack" : "Unstack");
							
						svg.selectAll(".bar")
							.transition()
							.attr("y", yBar)
					});
					
				const buttonAll = document.getElementsByClassName("buttonAll")[0];
				const buttonAllBox = buttonAll.getBoundingClientRect();
				
				buttonAll.style.display = "none";
					
				buttonAll.style.left = `${margin.left + width - buttonAllBox.width - buttonToggleBox.width - 5}px`;
				buttonAll.style.top = `${margin.top - buttonAllBox.height - 5}px`;
				
				d3.select(".buttonAll")
					.on("click", (evt) => {
						timeChart = false;
						drawChart();
						buttonAll.style.display = "none";
						inputDiv.style.display = "inline-block";
					});
					
				// Input
				const inputYear = document.getElementsByClassName("inputYear")[0];
				
				const inputDiv = document.getElementsByClassName("inputDiv")[0];
				const inputDivBox = inputDiv.getBoundingClientRect();
					
				inputDiv.style.left = `${margin.left + width - inputDivBox.width - buttonToggleBox.width - 5}px`;
				inputDiv.style.top = `${margin.top - inputDivBox.height - 5}px`;
				
				inputYear.addEventListener("change", (e) => {
					selectedYear = unformatYear(e.target.value);
					drawChart();
				});
				
				let options = "";
				for (let ye = 2020; ye > 1900; --ye) {
					options += `<option value${unformatYear(ye) === defaultYear ? " selected" : ""}="${ye}">${ye}</option>\n`;
				}
				
				inputYear.innerHTML = options;

				// Tooltips
				const toolTip = document.getElementsByClassName("tool-tip")[0];
				
				// Title
				svg.append("text")
					.attr("class", "chart-title")           
					.attr("x", String(width / 2))           
					.attr("y", "-40")
					.attr("text-anchor", "middle")  
					.style("font-size", "16px") 
					.text("Proportion of population holding equal amounts of income");
					
				svg.append("text")
					.attr("transform", "rotate(-90)")
					.attr("y", String(-margin.left))
					.attr("x", String(-(height / 2)))
					.attr("dy", "1em")
					.style("text-anchor", "middle")
					.text("Proportion of population");
					
				drawChart();
			}
		});
	}
});
});
        </script>
    </body>
</html>
