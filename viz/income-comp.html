<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<style type="text/css" media="screen, print">
			body { margin: 30px 50px; font-family: sans-serif; }
		</style>
		<title>Comparison of shares</title>
	</head>
	<body>
		<h1>Comparison of income shares</h1>

		<!-- Selector -->
<!--
		<form>
			  <div>
			    <label for="slct_country">Choose country :</label>
			    <input type="text" id="slct_country" value='US'>
					<button type='button' onclick="updateGraph()">Select</button>
			  </div>
		</form>
-->
        <div>
            <label for='countrySelector'>Country</label>
            <select id='countrySelector'>
                <option value='CN'>China</option>
                <option value='FR'>France</option>
                <option value='RU'>Russian Federation</option>
                <option value='US'>USA</option>
            </select>
        </div>
		<!-- Sliders -->
		<div>
			<label for="low_value">Choose bottom %:</label>
			<!-- <p class="col-sm-2" id="low_value" > -->
			<div class="col-sm" id="low_slider">
		</div>
        <div>
			<label for="high_value">Choose top %:</label>
			<!-- <p class="col-sm-2" id="high_value" > -->
			<div class="col-sm" id="high_slider">
		</div>
		<!-- Scripts -->
		<script src="../vendor/d3/d3.js"></script>
		<script src="https://unpkg.com/d3-simple-slider"></script>
		<script>

/*========== Function definitions ==========*/

function linApprox(x, xmin, xmax, ymin, ymax) {
    return ymin + (ymax - ymin) * (x - xmin) / (xmax - xmin);
}

function lowCumul(percentile, d) {
    return linApprox(percentile, d.low, d.high, d.cumul - d.share, d.cumul);
}

function highCumul(percentile, d) {
    return 1.0 - linApprox(percentile, d.low, d.high, d.cumul - d.share, d.cumul);
}

function loadCountries() {
    var temp = [];
    d3.tsv('../data/countries.tsv', function(error, data) {
        if (error) throw error;

        data.forEach(d => temp.push(d));
    });
    return temp;
}

function countryName(countryCode) {
    for (let i = 0; i < countries.length; ++i) {
        if (countries[i].code == countryCode) {
            return countries[i].name;
        }
    }
    return 'unknown';
}

function initDropdown(countries) {
/*
    d3.select('#countrySelector')
        .selectAll('option')
        .data(countries)
        .enter()
        .append('option')
            .attr('value', (d, i) => i)
            .text(d => d.name);
*/
/*
    let dropdown = d3.select('#countrySelector');
    for (let i = 0; i < countries.length; ++i) {
        dropdown.append('option')
            .attr('value', countries[i].code)
            .text(countries[i].name);
    }
*/
    d3.select('#countrySelector')
        .on('change', d => updateGraph());
}


// Function used when "Select" button is clicked
function updateGraph() {

	// get the text inputed
	var country = document.getElementById('countrySelector').value.toUpperCase();
	// get high and low values
	var hi_percentile = hiSlider.value();
	var lo_percentile = loSlider.value();
	// clear elemnts from th former svg (do not remove the svg itself)
	svg.selectAll("*").remove();

    // ============ Create graph ============
    d3.tsv(`../data/income/${country}.tsv`, function(error, data) {
    	if(error) throw error;

        // Income of lowest percentile
        lo_data = data
            .filter(d => d.low <= lo_percentile && lo_percentile < d.high)
            .sort((a, b) => +a.year - +b.year)
            .map(function (d) { return { year: d.year, cumul: lowCumul(lo_percentile, d)}; });
        // Income of highest percentile
        hi_data = data
            .filter(d => d.low <= hi_percentile && hi_percentile < d.high)
            .sort((a, b) => +a.year - +b.year)
            .map(function (d) { return { year: +d.year, cumul: highCumul(hi_percentile, d)}; });

        x.domain(d3.extent(data, d => +d.year));

    	var ts = d3.line()
    		.x(function(d) { return x(d.year); })
    		.y(function(d) { return y(d.cumul); });

    	var lo_income = svg.append("path").datum(lo_data)
    		.attr("d", ts)
    		.attr("stroke", lo_color)
    		.attr("stroke-width", 2)
    		.attr("fill", "none");

    	var hi_income = svg.append("path").datum(hi_data)
    		.attr("d", ts)
    		.attr("stroke", hi_color)
    		.attr("stroke-width", 2)
    		.attr("fill", "none");

        [0.0, 0.25, 0.5, 0.75].forEach(d =>
            svg.append("line")
        		.attr("x1", 0)
        		.attr("x2", width)
        		.attr("y1", height * d)
        		.attr("y2", height * d)
        		.attr("stroke", "lightgrey")
        		.attr("stroke-width", 1));

    	var xAxis = d3.axisBottom(x)
    		.tickFormat(d3.format("d"));

    	svg.append('g')
    		.attr('transform', 'translate(0,' + (y(0)+5) +')')
    		.call(xAxis);

    	svg.append('text')
    		.text("Year")
    		.attr('text-anchor', 'middle')
    		.attr('x', width / 2)
    		.attr('y', height + 40);

    	var yAxis = d3.axisRight(y);
    	svg.append('g')
    		.attr('transform', 'translate(' + (x(d3.max(data, d => +d.year))+5) +')')
    		.call(yAxis);

    	svg.append('text')
    		.text("Share of income")
    		.attr('transform', `translate(${width + 45}, ${height / 2}) rotate(-90)`)
    		.attr('text-anchor', 'middle');


    	svg.append('text')
    		.text("Share of population")
    		.attr('transform', `translate(-35, ${height / 2}) rotate(-90)`)
    		.attr('text-anchor', 'middle');

        svg.append('text')
            .text(`Country: ${countryName(country)}`)
                .attr('transform', `translate(${width / 2}, -20)`)
                .attr('text-anchor', 'middle')

    	lf = d3.format('.2p')
        svg.append('text')
    		.text(`Bottom ${lf(+lo_percentile)}`)
                .attr('transform', `translate(-10, ${height * 3 / 4}) rotate(-90)`)
                .attr('text-anchor', 'middle')
                .attr('fill', lo_color);
        svg.append('text')
            .text(`Top ${lf(1.0 - hi_percentile)}`)
                .attr('transform', `translate(-10, ${height / 4}) rotate(-90)`)
                .attr('text-anchor', 'middle')
                .attr('fill', hi_color);

    });
} // end function updateGraph()

// ============ Sliders ============
var highRange = [0.50, 0.55, 0.60, 0.65, 0.70, 0.75, 0.80, 0.85, 0.90, 0.95, 0.99];
var hiSlider = d3
	.sliderBottom()
	.min(d3.min(highRange))
	.max(d3.max(highRange))
	.width(500)
	.tickFormat(d3.format('.0%'))
	.ticks(10)
	.default(0.90)
	.on('onchange', val => {
		   d3.select('p#high_value').text(d3.format('.0%')(val));
           updateGraph();
		 });
var ghiSlider = d3
    .select('div#high_slider')
    .append('svg')
    .attr('width', 600)
    .attr('height', 70)
    .append('g')
    .attr('transform', 'translate(30,30)');
ghiSlider.call(hiSlider);
d3.select('p#high_value').text(d3.format('.0%')(hiSlider.value()));

var lowRange = [0.01, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30, 0.35, 0.40, 0.45, 0.50];
var loSlider = d3
	.sliderBottom()
	.min(d3.min(lowRange))
	.max(d3.max(lowRange))
	.width(500)
	.tickFormat(d3.format('.0%'))
	.ticks(10)
	.default(0.50)
	.on('onchange', val => {
		   d3.select('p#low_value').text(d3.format('.0%')(val));
           updateGraph();
		 });
var gloSlider = d3
    .select('div#low_slider')
    .append('svg')
    .attr('width', 600)
    .attr('height', 70)
    .append('g')
    .attr('transform', 'translate(30,30)');
gloSlider.call(loSlider);
d3.select('p#low_value').text(d3.format('.0%')(loSlider.value()));

// ============ Create svg ============
var countries = loadCountries();

var margin = {top: 50, right: 100, bottom: 100, left: 100},
    width = 800 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;

var x = d3.scaleLinear()
    .range([0, width]);

var y = d3.scaleLinear()
    .range([height, 0])
    .domain([0, 1]);

var svg = d3.select('body')
    .append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
    .append('g')
        .attr('transform', `translate(${margin.left}, ${margin.top})`);

var lo_color = 'blue';
var hi_color = 'darkorange';

initDropdown(countries);
updateGraph();

		</script>
	</body>
</html>
