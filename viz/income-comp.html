<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<style type="text/css" media="screen, print">
			body { margin: 30px 50px; font-family: sans-serif; }
		</style>
		<title>Comparison of shares</title>
	</head>
	<body>
		<h1>Comparison of income shares</h1>

		<script src="../vendor/d3/d3.js"></script>
		<script>

var margin = {top: 50, right: 100, bottom: 100, left: 100},
    width = 800 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;

var x = d3.scaleLinear()
    .range([0, width]);

var y = d3.scaleLinear()
    .range([height, 0])
    .domain([0, 1]);

var svg = d3.select('body')
    .append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
    .append('g')
        .attr('transform', `translate(${margin.left}, ${margin.top})`);

var country = 'US';
var lo_percentile = 0.5;
var hi_percentile = 0.9;
var lo_color = 'blue';
var hi_color = 'darkorange';

function lin_approx(x, xmin, xmax, ymin, ymax) {
    return ymin + (ymax - ymin) * (x - xmin) / (xmax - xmin);
}

function low_cumul(percentile, d) {
    return lin_approx(percentile, d.low, d.high, d.cumul - d.share, d.cumul);
}

function high_cumul(percentile, d) {
    return 1.0 - lin_approx(percentile, d.low, d.high, d.cumul - d.share, d.cumul);
}

d3.tsv(`../data/income/${country}.tsv`, function(error, data) {
	if(error) throw error;

    // Income of lowest percentile
    lo_data = data
        .filter(d => d.low <= lo_percentile && lo_percentile < d.high)
        .sort((a, b) => +a.year - +b.year)
        .map(function (d) { return { year: d.year, cumul: low_cumul(lo_percentile, d)}; });
    // Income of highest percentile
    hi_data = data
        .filter(d => d.low <= hi_percentile && hi_percentile < d.high)
        .sort((a, b) => +a.year - +b.year)
        .map(function (d) { return { year: +d.year, cumul: high_cumul(hi_percentile, d)}; });

    x.domain(d3.extent(data, d => +d.year));

	var ts = d3.line()
		.x(function(d) { return x(d.year); })
		.y(function(d) { return y(d.cumul); });

	var lo_income = svg.append("path").datum(lo_data)
		.attr("d", ts)
		.attr("stroke", lo_color)
		.attr("stroke-width", 2)
		.attr("fill", "none");

	var hi_income = svg.append("path").datum(hi_data)
		.attr("d", ts)
		.attr("stroke", hi_color)
		.attr("stroke-width", 2)
		.attr("fill", "none");
/*
	var l100 = svg.append("line")
		.attr("x1", x(d3.min(data, d => +d.year)))
		.attr("x2", x(d3.max(data, d => +d.year)))
		.attr("y1", y(1.))
		.attr("y2", y(1.))
		.attr("stroke", "black")
		.attr("stroke-width", 1);
*/
	var xAxis = d3.axisBottom(x)
		.tickFormat(d3.format("d"));

	svg.append('g')
		.attr('transform', 'translate(0,' + (y(0)+5) +')')
		.call(xAxis);

	svg.append('text')
		.text("Year")
		.attr('text-anchor', 'middle')
		.attr('x', width / 2)
		.attr('y', height + 40);

	var yAxis = d3.axisRight(y);
	svg.append('g')
		.attr('transform', 'translate(' + (x(d3.max(data, d => +d.year))+5) +')')
		.call(yAxis);

	svg.append('text')
		.text("Share of income")
		.attr('transform', `translate(${width + 45}, ${height / 2}) rotate(-90)`)
		.attr('text-anchor', 'middle');


	svg.append('text')
		.text("Share of population")
		.attr('transform', `translate(-35, ${height / 2}) rotate(-90)`)
		.attr('text-anchor', 'middle');

    svg.append('text')
        .text(`Country code: ${country}`)
            .attr('transform', `translate(${width / 2}, -20)`)
            .attr('text-anchor', 'middle')

	lf = d3.format('.2p')
    svg.append('text')
		.text(`Bottom ${lf(+lo_percentile)}`)
            .attr('transform', `translate(-10, ${height * 3 / 4}) rotate(-90)`)
            .attr('text-anchor', 'middle')
            .attr('fill', lo_color)
//    		.attr('x', -3)
//    		.attr('y', y(lo_data[0].cumul))
//    		.attr('text-anchor', 'end');
    svg.append('text')
		.text(`Top ${lf(1.0 - hi_percentile)}`)
        .attr('transform', `translate(-10, ${height / 4}) rotate(-90)`)
        .attr('text-anchor', 'middle')
        .attr('fill', hi_color)

});

		</script>
	</body>
</html>
